<!-- index.html (Frontend seguro + JWT + render sin innerHTML) -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat IA</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial }
    body { margin: 0; background: #0b0c10; color: #e5e7eb }
    .wrap { max-width: 860px; margin: 40px auto; padding: 0 16px }
    .card { background:#111217; border:1px solid #1f2430; border-radius:16px; padding:16px 18px; box-shadow: 0 6px 24px rgba(0,0,0,.25) }
    .row { display:flex; gap:10px; align-items:center }
    .row input { flex:1; padding:12px 14px; border-radius:12px; border:1px solid #303645; background:#0f1116; color:#e5e7eb }
    .row button { padding:12px 16px; border-radius:12px; border:1px solid #3b82f6; background:#1d4ed8; color:white; cursor:pointer }
    .row button:disabled { opacity:.6; cursor:not-allowed }
    .mt { margin-top:16px }
    .muted { color:#9aa4b2; font-size:.9rem }
    .cols { display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width: 900px) { .cols { grid-template-columns: 1fr 1fr } }
    pre { white-space:pre-wrap; background:#0f1116; border:1px solid #1f2430; padding:12px; border-radius:12px; margin:0 }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#0b3b1c; color:#86efac; border:1px solid #14532d; font-size:.75rem }
    .err { background:#3b0b0b; color:#fecaca; border-color:#7f1d1d }
  </style>
  <!-- Supabase JS v2 (CDN oficial) -->
  <script src="https://esm.sh/@supabase/supabase-js@2.45.4"></script>
</head>
<body>
  <div class="wrap">
    <h1>Chat IA</h1>
    <div class="card">
      <div class="row">
        <input id="q" placeholder="Escribe tu pregunta (p.ej. 'promedio de bandwidth del último mes')" />
        <button id="send">Preguntar</button>
      </div>
      <div class="mt muted">
        <div>Estado: <span id="state" class="badge">listo</span></div>
        <div class="mt">Consejo: debes estar autenticado para que funcione **RLS** (*Row Level Security*).</div>
      </div>
    </div>

    <div class="card mt">
      <h3>Respuesta</h3>
      <div class="cols">
        <div>
          <div class="muted">[RESULTADO]</div>
          <pre id="out-result"><code></code></pre>
        </div>
        <div>
          <div class="muted">[PROCESO]</div>
          <pre id="out-process"><code></code></pre>
        </div>
      </div>
    </div>

    <div class="card mt">
      <h3>Debug</h3>
      <pre id="out-debug"><code></code></pre>
    </div>
  </div>

<script type="module">
/** ================================
 *  CONFIG exacta (ubicación en Supabase)
 *  - SUPABASE_URL y SUPABASE_ANON_KEY: Dashboard → Project Settings → API
 *  - EDGE URL: Dashboard → Edge Functions → chat-query → Invoke URL
 * ================================= */
const SUPABASE_URL = "<TU_SUPABASE_URL>";
const SUPABASE_ANON_KEY = "<TU_SUPABASE_ANON_KEY>";
const EDGE_URL = "<TU_EDGE_FUNCTION_INVOKE_URL>/functions/v1/chat-query"; // ej: https://xyz.functions.supabase.co/functions/v1/chat-query

// Instancia cliente
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** Helpers UI */
const $ = (id) => document.getElementById(id);
const state = $("state");
const outResult = $("out-result").querySelector("code");
const outProcess = $("out-process").querySelector("code");
const outDebug = $("out-debug").querySelector("code");
const sendBtn = $("send");
const input = $("q");

function setState(text, ok=true) {
  state.textContent = text;
  state.className = ok ? "badge" : "badge err";
}
function showDebug(obj) {
  outDebug.textContent = JSON.stringify(obj, null, 2);
}
function showAnswer(answer) {
  // answer esperado: string con etiquetas [RESULTADO] ... [/RESULTADO] y [PROCESO] ... [/PROCESO]
  const resMatch = /\[RESULTADO\]([\s\S]*?)\[\/RESULTADO\]/i.exec(answer);
  const proMatch = /\[PROCESO\]([\s\S]*?)\[\/PROCESO\]/i.exec(answer);
  outResult.textContent = (resMatch?.[1] || "").trim();
  outProcess.textContent = (proMatch?.[1] || "").trim();
}

/** Obtener el JWT (JSON Web Token) del usuario actual
 *  - Ubicación exacta en plataforma: si usas Supabase Auth,
 *    el token está en session.access_token (Auth → Users para pruebas)
 */
async function getAccessToken() {
  const { data: { session }, error } = await supabase.auth.getSession();
  if (error) throw error;
  if (!session?.access_token) throw new Error("No hay sesión. Inicia sesión antes de preguntar.");
  return session.access_token;
}

/** Enviar pregunta a la Edge Function con Authorization: Bearer <jwt> */
async function ask(question) {
  const token = await getAccessToken(); // ← imprescindible para RLS (Row Level Security)
  const r = await fetch(EDGE_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`, // JWT
    },
    body: JSON.stringify({ question })
  });
  const isJson = (r.headers.get("content-type") || "").includes("application/json");
  const payload = isJson ? await r.json() : { raw: await r.text() };

  return { ok: r.ok, status: r.status, payload };
}

/** Evento UI */
sendBtn.addEventListener("click", async () => {
  const question = (input.value || "").trim();
  if (!question) return;

  sendBtn.disabled = true;
  setState("enviando...");
  showDebug({});

  try {
    const res = await ask(question);
    showDebug(res);

    if (!res.ok) {
      setState(`error ${res.status}`, false);
      outResult.textContent = "";
      outProcess.textContent = "";
      return;
    }

    setState("ok");
    showAnswer(res.payload.answer || "");
  } catch (e) {
    setState("error", false);
    showDebug({ error: String(e?.message || e) });
    outResult.textContent = "";
    outProcess.textContent = "";
  } finally {
    sendBtn.disabled = false;
  }
});

/** OPCIONAL: auto-intento de sesión por URL hash si usas magic link, etc. */
(async function bootstrap() {
  // Si usas OAuth/Magic link, podrías llamar a supabase.auth.getSession() aquí para calentar.
  const { data: { session } } = await supabase.auth.getSession();
  showDebug({ session_present: !!session });
})();
</script>
</body>
</html>
