<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution Chat</title>

    <!-- Bootstrap (solo para Collapse) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff; min-height: 100vh; display: flex; justify-content: center; align-items: center;
        }
        .container { width: 640px; padding: 40px 0; }
        .messages { min-height: 400px; max-height: 70vh; overflow-y: auto; margin-bottom: 40px; padding: 20px 0;
            scrollbar-width: none; -ms-overflow-style: none; }
        .messages::-webkit-scrollbar { display: none; }
        .message { margin-bottom: 12px; margin-left: 60px; position: relative; animation: fadeIn 0.3s ease; }
        .user-message { font-size: 18px; color: #404040; font-weight: 500; text-transform: uppercase; letter-spacing: 0.02em; max-width: 440px; }
        .user-message::before { content: ''; position: absolute; left: -40px; top: 4px; width: 12px; height: 12px; background: #000000; border-radius: 50%; }
        .assistant-message { font-size: 14px; color: #404040; line-height: 1.6; max-width: 440px; }
        .assistant-message h1 { font-size: 20px; font-weight: 700; margin: 20px 0 12px 0; color: #000000; border-bottom: 2px solid #e5e5e5; padding-bottom: 8px; }
        .assistant-message h2 { font-size: 16px; font-weight: 600; margin: 18px 0 10px 0; color: #202020; }
        .assistant-message h3 { font-size: 14px; font-weight: 600; margin: 16px 0 8px 0; color: #202020; }
        .assistant-message p { margin-bottom: 12px; line-height: 1.6; }
        .assistant-message strong { font-weight: 600; color: #000000; }
        .assistant-message em { font-style: italic; }
        .assistant-message code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 12px; color: #d73a49; }
        .assistant-message pre { background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin: 12px 0; overflow-x: auto; line-height: 1.45; }
        .assistant-message pre code { background: none; padding: 0; color: #24292e; font-size: 12px; }
        .assistant-message blockquote { margin: 12px 0; padding: 0 16px; border-left: 4px solid #dfe2e5; color: #6a737d; }
        .assistant-message hr { margin: 16px 0; border: 0; border-top: 1.5px solid rgba(0,0,0,0.8); }
        .assistant-message ul, .assistant-message ol { margin: 8px 0; padding-left: 20px; }
        .assistant-message li { margin: 4px 0; }

        /* Resultado */
        .result-section { margin-bottom: 24px; }
        .result-label { font-size: 14px; font-weight: 600; color: #000000; margin-bottom: 12px; display: block; }

        /* Proceso (collapsible) */
        .process-section { margin-top: 20px; }
        .process-header {
            font-size: 14px; font-weight: 600; color: #000; margin-bottom: 12px;
            display: flex; align-items: center; cursor: pointer; user-select: none;
            background: transparent; border: 0; padding: 0;
        }
        .process-header:hover { opacity: 0.7; }
        .process-arrow { margin-left: 8px; font-size: 12px; display: inline-block; transition: transform .2s; }
        /* Con Bootstrap, el botón tiene .collapsed cuando está cerrado */
        .process-header:not(.collapsed) .process-arrow { transform: rotate(180deg); }
        .process-content { padding-top: 8px; padding-left: 20px; font-size: 13px; color: #666; line-height: 1.7; }
        .process-content strong { color: #404040; }

        .typing-indicator { margin-left: 60px; height: 20px; }
        .typing-dot { display: inline-block; width: 8px; height: 8px; background: #404040; border-radius: 50%; margin-right: 4px; animation: typingPulse 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .input-container { position: relative; }
        .input-field {
            width: 100%; padding: 20px 60px 20px 24px; border: 2px solid #e5e5e5; border-radius: 50px;
            font-size: 16px; color: #333; background: #fff; outline: none; transition: all .2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
        }
        .input-field:focus { border-color: #666; box-shadow: 0 4px 16px rgba(0,0,0,.12); }
        .input-field::placeholder { color: #999; font-weight: 400; }
        .send-button {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px; border: none; border-radius: 50%; background: #333; color: #fff;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }
        .send-button:hover:not(:disabled) { background: #000; transform: translateY(-50%) scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,.25); }
        .send-button:disabled { background: #f0f0f0; color: #ccc; cursor: not-allowed; box-shadow: none; transform: translateY(-50%) scale(1); }
        .send-button svg { width: 20px; height: 20px; transform: rotate(-90deg); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
        @keyframes typingPulse { 0%, 60%, 100% { opacity: .3;} 30% { opacity: 1;} }
    </style>
</head>
<body>
<div class="container">
    <div class="messages" id="messages"></div>
    <div class="input-container">
        <input type="text" class="input-field" id="input" placeholder="Pregunta lo que necesitas, encuentra lo que buscas." autocomplete="off"/>
        <button class="send-button" id="sendBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12l14 0M12 5l7 7-7 7"/>
            </svg>
        </button>
    </div>
</div>

<!-- Bootstrap JS (bundle con Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const SUPABASE_URL = 'https://tzoiscozwjnuxmecwtqi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6b2lzY296d2pudXhtZWN3dHFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDQ4MTEsImV4cCI6MjA3MTE4MDgxMX0.67idmsow4i51CLKf3a07UGYvHOepZ50tryvyJH3pKaY';

const messagesDiv = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');

let isLoading = false;

/* ====== Memoria de conversación ====== */
class ConversationMemory {
    constructor(){ this.context = null; this.CONTEXT_DURATION = 10*60*1000; }
    updateContext(query, answer){
        this.context = { lastQuery: query, lastAnswer: answer, entities: this.extractEntities(query, answer), timestamp: Date.now() };
    }
    extractEntities(query, answer){
        const combined = (query + ' ' + answer).toLowerCase();
        return { projects: this.extractProjects(combined), people: this.extractPeople(answer) };
    }
    extractProjects(text){
        const projects = []; const knownProjects = ['dataverse','delta','sid','hornblower','data'];
        knownProjects.forEach(p => { if (text.includes(p)) projects.push(p); }); return projects;
    }
    extractPeople(text){
        const namePattern = /[A-ZÁÉÍÓÚ][a-záéíóú]+ [A-ZÁÉÍÓÚ][a-záéíóú]+/g; const matches = text.match(namePattern); return matches || [];
    }
    enhanceQuery(newQuery){
        if(!this.context || Date.now() - this.context.timestamp > this.CONTEXT_DURATION) return newQuery;
        const q = newQuery.toLowerCase();
        if (q.includes('ellos') || q.includes('estos') || q.includes('esos')) {
            if (this.context.entities.people.length > 0) return newQuery + ` (contexto: hablábamos de ${this.context.entities.people.join(', ')})`;
        }
        if (q.includes('ese proyecto') || q.includes('el proyecto') || q.includes('mismo')) {
            if (this.context.entities.projects.length > 0) return newQuery + ` (contexto: proyecto ${this.context.entities.projects[0]})`;
        }
        if ((q.includes('senior') || q.includes('junior') || q.includes('cuáles')) &&
            !q.includes('empleado') && !q.includes('persona')) {
            if (this.context.lastQuery.includes('empleado') || this.context.lastQuery.includes('proyecto')) {
                return newQuery + ` (contexto anterior: ${this.context.lastQuery})`;
            }
        }
        return newQuery;
    }
}
const memory = new ConversationMemory();

/* ====== Normalizador robusto de marcadores ======
   - Tolera cierres cruzados ([/RESULTADO] cerrando PROCESO y viceversa)
   - Tolera mayúsculas/minúsculas y faltas de cierre (corta por siguiente marcador o fin) */
function normalizeAndSplit(content){
    const processRegex = /\[PROCESO\]([\s\S]*?)(?:\[\/PROCESO\]|\[\/RESULTADO\]|$)/i;
    const resultRegex  = /\[RESULTADO\]([\s\S]*?)(?:\[\/RESULTADO\]|\[\/PROCESO\]|$)/i;

    const pMatch = content.match(processRegex);
    const rMatch = content.match(resultRegex);

    const process = pMatch ? pMatch[1].trim() : '';
    const result  = rMatch ? rMatch[1].trim() : '';

    return { process, result, hasAny: !!(process || result) };
}

/* ====== Formateo de contenido (markdown-lite → HTML) ====== */
function formatBasicContent(content){
    let formatted = content
        .replace(/^(\d+)\.\s+(.+?)(?:\n(?!\d+\.)(.+?))?$/gm, (m, num, first, second) => {
            if (second && !second.match(/^\d+\./)) return `**${num}.** ${first}\n   ${second}`; return `**${num}.** ${first}`;
        })
        .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
        .replace(/^---$/gm, '<hr>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
        .replace(/^[\*\-\+] (.+)$/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>');

    formatted = formatted.replace(/(<li>.*?<\/li>(?:<br>)?)+/g, (match) => '<ul>' + match.replace(/<br>/g, '') + '</ul>');
    formatted = formatted.replace(/(<br>){2,}/g, '<br><br>');
    return formatted;
}

/* ====== Composición de mensaje: RESULTADO primero, PROCESO colapsable ====== */
function formatMessage(rawContent){
    const { process, result, hasAny } = normalizeAndSplit(rawContent);

    if (!hasAny) return formatBasicContent(rawContent); // sin estructura

    const messageId = 'msg-' + Date.now();
    const hasResult = !!result;
    const hasProcess = !!process;

    let html = '';

    if (hasResult){
        html += `
<div class="result-section">
  <span class="result-label">Resultado:</span>
  ${formatBasicContent(result)}
</div>`;
    }

    if (hasResult && hasProcess) html += '<hr>';

    if (hasProcess){
        html += `
<div class="process-section">
  <button class="process-header collapsed" type="button"
          data-bs-toggle="collapse" data-bs-target="#process-${messageId}"
          aria-expanded="false" aria-controls="process-${messageId}">
      Proceso <span class="process-arrow">↓</span>
  </button>
  <div class="process-content collapse" id="process-${messageId}">
      ${formatBasicContent(process)}
  </div>
</div>`;
    }

    if (!hasResult && hasProcess){
        html = `
<div class="process-section">
  <div class="mb-2" style="font-size:12px;color:#B00020;">Falta [RESULTADO] en la respuesta del modelo.</div>
  <button class="process-header collapsed" type="button"
          data-bs-toggle="collapse" data-bs-target="#process-${messageId}"
          aria-expanded="false" aria-controls="process-${messageId}">
      Proceso <span class="process-arrow">↓</span>
  </button>
  <div class="process-content collapse" id="process-${messageId}">
      ${formatBasicContent(process)}
  </div>
</div>`;
    }
    return html;
}

async function sendMessage(){
    const originalQuestion = input.value.trim();
    if (!originalQuestion || isLoading) return;

    const enhancedQuestion = memory.enhanceQuery(originalQuestion);

    const userDiv = document.createElement('div');
    userDiv.className = 'message user-message';
    userDiv.textContent = originalQuestion.toUpperCase();
    messagesDiv.appendChild(userDiv);

    input.value = ''; isLoading = true; sendBtn.disabled = true;

    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try{
        const response = await fetch(`${SUPABASE_URL}/functions/v1/chat-query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
            body: JSON.stringify({ question: enhancedQuestion })
        });
        const data = await response.json();

        typingDiv.remove();

        const assistantDiv = document.createElement('div');
        assistantDiv.className = 'message assistant-message';
        messagesDiv.appendChild(assistantDiv);

        const fullText = data.answer || 'No pude procesar la pregunta';
        memory.updateContext(originalQuestion, fullText);

        // Nueva detección robusta
        const structured = normalizeAndSplit(fullText).hasAny;

        if (structured){
            assistantDiv.innerHTML = formatMessage(fullText);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
            // Typewriter para respuestas sin estructura
            let currentIndex = 0;
            (function typeWriter(){
                if (currentIndex < fullText.length){
                    const currentText = fullText.slice(0, currentIndex + 1);
                    assistantDiv.innerHTML = formatMessage(currentText);
                    currentIndex++; messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    setTimeout(typeWriter, 8);
                }
            })();
        }
    } catch (error){
        typingDiv.remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message assistant-message';
        errorDiv.textContent = 'Error al conectar con el servidor. Intenta de nuevo.';
        messagesDiv.appendChild(errorDiv);
    } finally {
        isLoading = false; sendBtn.disabled = false; input.focus();
    }
}

sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
input.focus();
</script>
</body>
</html>