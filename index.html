<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Distribution Chat</title>
  
  <!-- Agregar librería para renderizar Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--black-90:rgba(0,0,0,.9);--black-80:rgba(0,0,0,.8);--bg:#fff;--main-text-color:#222}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center;align-items:center;color:var(--main-text-color)}
    .container{width:640px;padding:40px 0}
    .messages{min-height:400px;max-height:70vh;overflow-y:auto;margin-bottom:40px;padding:20px 0;scrollbar-width:none;-ms-overflow-style:none}
    .messages::-webkit-scrollbar{display:none}
    .message{margin-bottom:14px;margin-left:60px;position:relative;animation:fadeIn .25s ease}
    .user-message{font-size:18px;color:var(--main-text-color);font-weight:600;text-transform:uppercase;letter-spacing:.02em;max-width:520px}
    .user-message::before{content:'';position:absolute;left:-40px;top:5px;width:12px;height:12px;background:#000;border-radius:50%}
    .assistant-message{font-size:15px;color:var(--main-text-color);line-height:1.65;max-width:520px;opacity:0;transform:translateY(20px);transition:all .4s ease-out}
    .assistant-message.visible{opacity:1;transform:translateY(0)}
    
    /* Estilos para Markdown renderizado - AJUSTADOS */
    .assistant-message h1, .assistant-message h2, .assistant-message h3 {
      font-weight:600;
      color:var(--main-text-color);
      margin:12px 0 8px;
      font-size:15px; /* Tamaño uniforme como solicitaste */
    }
    .assistant-message h1 {font-size:15px}
    .assistant-message h2 {font-size:15px}
    .assistant-message h3 {font-size:15px}
    .assistant-message strong{font-weight:600;color:var(--main-text-color)} /* Mismo color que la pregunta */
    .assistant-message ul,.assistant-message ol{margin:8px 0 8px 22px}
    .assistant-message li{margin:4px 0;color:var(--main-text-color)}
    .assistant-message p{margin:8px 0;color:var(--main-text-color)}
    .assistant-message code{
      background:#f5f5f5;
      padding:2px 4px;
      border-radius:3px;
      font-family:'SF Mono',Monaco,monospace;
      font-size:14px;
      color:var(--main-text-color);
    }
    .assistant-message blockquote{
      border-left:3px solid #ddd;
      padding-left:12px;
      margin:8px 0;
      color:var(--main-text-color);
    }
    
    /* Mejoras específicas para estados de bandwidth */
    .assistant-message .status-emoji {
      font-size: 14px;
      margin-right: 4px;
    }
    
    .assistant-message .bandwidth-status {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .bandwidth-available { 
      background-color: #e8f5e8; 
      color: #2d5a2d; 
    }
    
    .bandwidth-stable { 
      background-color: #f8f9fa; 
      color: #495057; 
    }
    
    .bandwidth-overloaded { 
      background-color: #fff3e0; 
      color: #e65100; 
    }
    
    .proc-sep{margin:16px 0;border:0;border-top:1px solid var(--black-90)}
    .process-section{margin-top:10px}
    .process-header{font-size:15px;font-weight:600;color:var(--main-text-color);margin:6px 0 8px;display:flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
    .process-arrow{font-size:13px;display:inline-block;min-width:14px}
    .process-content{display:none;padding-top:8px;font-size:13px;color:var(--main-text-color);line-height:1.7}
    .process-content.visible{display:block}
    .process-content h4 {
      color: var(--main-text-color);
      font-size: 15px; /* Ajustado a 15px */
      margin: 8px 0 4px;
      font-weight: 600;
    }
    .process-content ul {
      margin-left: 16px;
      margin-bottom: 12px;
    }
    .process-content li {
      margin: 2px 0;
      font-size: 13px;
      color: var(--main-text-color);
    }
    .process-content strong {
      color: var(--main-text-color);
      font-weight: 600;
    }
    .process-content p {
      color: var(--main-text-color);
    }
    .metric-highlight {
      background-color: #f8f9fa;
      padding: 1px 4px;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      color: var(--main-text-color);
    }
    
    .typing-indicator{margin-left:60px;height:18px;color:var(--black-80);font-size:13px}
    .typing-indicator.retry{color:#ff9800}
    .input-container{position:relative}
    .input-field{width:100%;padding:20px 60px 20px 24px;border:2px solid #e5e5e5;border-radius:50px;font-size:16px;color:var(--main-text-color);background:#fff;outline:none;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .input-field:focus{border-color:#666;box-shadow:0 4px 16px rgba(0,0,0,.12)}
    .send-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:44px;height:44px;border:none;border-radius:50%;background:#111;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .send-button:hover:not(:disabled){background:#000;transform:translateY(-50%) scale(1.04);box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .send-button:disabled{background:#f0f0f0;color:#aaa;cursor:not-allowed;box-shadow:none;transform:translateY(-50%)}
    .send-button svg{width:20px;height:20px;transform:rotate(-90deg)}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px}
    .st-1{background:#2ecc71}.st-0{background:#bdc3c7}.st--1{background:#e74c3c}
    .error{color:#b00020}
    .warning{color:#ff9800}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="messages" id="messages"></div>
    <div class="input-container">
      <input type="text" class="input-field" id="input" placeholder="Escribe tu consulta..." autocomplete="off"/>
      <button class="send-button" id="sendBtn" aria-label="Enviar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12l14 0M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.APP_CONFIG || {};
  const hasCfg = !!(SUPABASE_URL && SUPABASE_ANON_KEY);

  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  let isLoading = false;
  let retryTimeouts = [];

  if (!hasCfg) {
    const warn = document.createElement('div');
    warn.className='message assistant-message error visible';
    warn.textContent='config.js no cargado: define SUPABASE_URL y SUPABASE_ANON_KEY';
    messagesDiv.appendChild(warn);
    sendBtn.disabled = true; input.disabled = true;
  }

  const scrollToBottom = () => { messagesDiv.scrollTop = messagesDiv.scrollHeight; };
  
  // NUEVA: Función para detectar idioma
  function detectLanguage(text) {
    // Palabras comunes en inglés
    const englishWords = ['the', 'is', 'at', 'which', 'on', 'are', 'as', 'able', 'about', 'above', 'who', 'what', 'where', 'when', 'why', 'how', 'good', 'best', 'can', 'could', 'would', 'should'];
    // Palabras comunes en español
    const spanishWords = ['el', 'la', 'de', 'que', 'y', 'a', 'en', 'un', 'es', 'se', 'no', 'te', 'lo', 'le', 'da', 'su', 'por', 'son', 'con', 'para', 'una', 'del', 'los', 'las', 'como', 'más', 'quién', 'qué', 'dónde', 'cuándo', 'por qué', 'cómo', 'bueno', 'mejor', 'puede', 'podría'];
    
    const words = text.toLowerCase().split(/\s+/);
    let englishScore = 0;
    let spanishScore = 0;
    
    words.forEach(word => {
      if (englishWords.includes(word)) englishScore++;
      if (spanishWords.includes(word)) spanishScore++;
    });
    
    // Si no hay palabras identificativas, detectar por patrones
    if (englishScore === 0 && spanishScore === 0) {
      // Patrones típicos en inglés
      if (/\b(who|what|where|when|why|how|is|are|can|good|at)\b/i.test(text)) {
        return 'en';
      }
      // Patrones típicos en español
      if (/\b(quién|qué|dónde|cuándo|por qué|cómo|es|está|puede|bueno|en)\b/i.test(text)) {
        return 'es';
      }
    }
    
    return englishScore > spanishScore ? 'en' : 'es';
  }
  
  // FUNCIÓN MEJORADA PARA RENDERIZAR MARKDOWN CON LIMPIEZA COMPLETA DE TAGS
  const renderMarkdown = (text) => {
    if (!text) return '';
    
    console.log("Raw text before cleaning:", text); // Para debugging temporal
    
    // Limpiar TODOS los tags de estructura que no deben ser visibles
    let cleanedText = text
      // Eliminar tags de cierre
      .replace(/\[\/RESULTADO\]/gi, '')
      .replace(/\[\/RESULT\]/gi, '')
      .replace(/\[\/PROCESO\]/gi, '')  
      .replace(/\[\/PROCESS\]/gi, '')
      // Eliminar tags de apertura
      .replace(/\[RESULTADO\]/gi, '')
      .replace(/\[RESULT\]/gi, '')
      .replace(/\[PROCESO\]/gi, '')
      .replace(/\[PROCESS\]/gi, '')
      // Limpiar cualquier variación que pueda quedar
      .replace(/\[\/?(?:RESULTADO|RESULT|PROCESO|PROCESS)\]/gi, '')
      // Limpiar líneas vacías extra
      .replace(/\n{3,}/g, '\n\n')
      .trim();
    
    console.log("Cleaned text:", cleanedText); // Para debugging temporal
    
    // Usar marked.js para convertir Markdown a HTML
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: false
      });
      
      return marked.parse(cleanedText);
    }
    
    // Fallback si marked no está disponible
    return cleanedText
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
      .replace(/\n/g, '<br>');
  };

  // Función mejorada para post-procesar respuestas
  function enhanceResponseDisplay(html) {
    // Detectar y destacar métricas
    html = html.replace(/(\d+)\s*(miembros?|equipos?|registros?|members?|teams?|records?)/g, 
      '<span class="metric-highlight">$1</span> $2');
    
    // Mejorar formato de estados de bandwidth (inglés y español)
    html = html.replace(/(🟢\s*(Disponible|Available))/g, 
      '<span class="bandwidth-status bandwidth-available">$1</span>');
    
    html = html.replace(/(⚪\s*(Estable|Stable))/g, 
      '<span class="bandwidth-status bandwidth-stable">$1</span>');
    
    html = html.replace(/(🟠\s*(Sobrecargado|Overloaded))/g, 
      '<span class="bandwidth-status bandwidth-overloaded">$1</span>');
    
    return html;
  }

  function buildBlock(resultHTML, processHTML, language = 'es'){
    const id='m'+Date.now()+Math.floor(Math.random()*1e4);
    
    // Aplicar mejoras de visualización
    const enhancedResult = enhanceResponseDisplay(resultHTML || '—');
    const enhancedProcess = renderMarkdown(processHTML) || '';
    
    // CAMBIO: Siempre usar "Process" independientemente del idioma
    const processLabel = 'Process';
    
    const html = `
      <div class="result-section" id="result-${id}">${enhancedResult}</div>
      <hr class="proc-sep">
      <div class="process-section">
        <div class="process-header" data-target="${id}">
          <span>${processLabel}</span><span class="process-arrow" id="arrow-${id}">▼</span>
        </div>
        <div class="process-content" id="process-${id}">${enhancedProcess}</div>
      </div>`;
    return { id, html };
  }

  function toggleProcess(id){
    const proc=document.getElementById('process-'+id);
    const arrow=document.getElementById('arrow-'+id);
    if(!proc)return;
    const vis=proc.classList.toggle('visible');
    if(arrow) arrow.textContent=vis?'▲':'▼';
  }

  function renderFromStructured(structured, fallback){
    if (structured && structured.profile){
      const p = structured.profile;
      const sv = typeof p.bandwidth === 'number' ? p.bandwidth : null;
      const dotClass = sv === 1 ? 'st-1' : (sv === -1 ? 'st--1' : 'st-0');
      const assoc = p.associate ? 'Sí' : 'No';
      const deps = [p.team, ...(p.departments||[])].filter(Boolean).join(' · ') || '—';
      const skills = p.skills?.length ? p.skills.join(', ') : '—';
      const projs = p.projects?.length ? p.projects.join(', ') : '—';
      const notes = p.notes?.length ? p.notes.map(n=>n.text).join(' · ') : '—';
      const updates = p.updates?.length ? p.updates.map(u=> (u.project?`${u.project}: `:'') + u.text).join(' · ') : '—';

      return `
        <h3>${p.name}</h3>
        <p><span class="status-dot ${dotClass}"></span><strong>${p.bandwidth_label}</strong></p>
        <ul>
          <li><strong>Rol:</strong> ${p.role || '—'}</li>
          <li><strong>Seniority:</strong> ${p.seniority || '—'}</li>
          <li><strong>Equipo / Deps:</strong> ${deps}</li>
          <li><strong>Ubicación:</strong> ${p.location || '—'}</li>
          <li><strong>Associate:</strong> ${assoc}</li>
          ${p.email ? `<li><strong>Email:</strong> ${p.email}</li>` : ''}
          ${p.manager ? `<li><strong>Manager:</strong> ${p.manager}</li>` : ''}
          ${p.startDate ? `<li><strong>Inicio:</strong> ${new Date(p.startDate).toISOString().slice(0,10)}</li>` : ''}
          <li><strong>Skills:</strong> ${skills}</li>
          <li><strong>Proyectos:</strong> ${projs}</li>
          <li><strong>Notas:</strong> ${notes}</li>
          <li><strong>Updates:</strong> ${updates}</li>
        </ul>
      `;
    }
    if (structured && Array.isArray(structured.items) && structured.items.length){
      const title = `<p><strong>Resultados (${structured.items.length})</strong></p>`;
      const list = structured.items.map((it)=>{
        const sv = typeof it.status_value === 'number' ? it.status_value : null;
        const label = it.status_label || '';
        const dotClass = sv === 1 ? 'st-1' : (sv === -1 ? 'st--1' : 'st-0');
        const name = it.name ? `<strong>${it.name}</strong>` : '';
        const role = it.role ? ` — ${it.role}` : '';
        return `<li><span class="status-dot ${dotClass}"></span>${name}${role}${label ? ` — ${label}` : ''}</li>`;
      }).join('');
      const note = structured.note ? `<br><strong>Nota:</strong> ${renderMarkdown(structured.note)}` : '';
      return `${title}<ol>${list}</ol>${note}`;
    }
    
    // USAR MARKDOWN PARA EL FALLBACK (aplicando limpieza)
    return renderMarkdown(fallback || '—');
  }

  function getConversationId(){
    const k='chat_conversation_id';
    let id = localStorage.getItem(k);
    if(!id){ id = self.crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()); localStorage.setItem(k,id); }
    return id;
  }

  function apiFetch(path, options={}){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 45000);
    return fetch(`${SUPABASE_URL}${path}`, {
      ...options,
      headers:{
        'Content-Type':'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        ...(options.headers||{})
      },
      signal: ctrl.signal
    }).finally(()=>clearTimeout(t));
  }

  async function sendMessage(question = null, retryCount = 0){
    if(!hasCfg) return;
    
    if (!question) {
      question = input.value.trim();
      if(!question || isLoading) return;
      
      const u = document.createElement('div');
      u.className='message user-message';
      u.textContent=question.toUpperCase();
      messagesDiv.appendChild(u);
      
      input.value=''; 
    }
    
    input.focus();
    isLoading=true; 
    sendBtn.disabled=true;

    // Detectar idioma de la pregunta
    const detectedLanguage = detectLanguage(question);
    console.log('Detected language:', detectedLanguage);

    const typing=document.createElement('div');
    typing.className='typing-indicator';
    
    if (retryCount > 0) {
      typing.className += ' retry';
      typing.textContent=`Reintentando... (intento ${retryCount + 1})`;
    } else {
      typing.textContent='thinking…';
    }
    
    messagesDiv.appendChild(typing);
    scrollToBottom();

    try{
      const r = await apiFetch('/functions/v1/chat-query', {
        method:'POST',
        body: JSON.stringify({ 
          question, 
          conversation_id: getConversationId(),
          language: detectedLanguage // Enviar idioma detectado al backend
        })
      });

      if(!r.ok){
        typing.remove();
        const a = document.createElement('div');
        a.className='message assistant-message error visible';
        a.textContent = `No pudimos procesar la consulta (HTTP ${r.status}).`;
        messagesDiv.appendChild(a); 
        scrollToBottom(); 
        return;
      }

      const data = await r.json();
      console.log("Respuesta backend completa:", data);
      typing.remove();

      if(data && data.ok === false && data.retry_after && retryCount < 3){
        const retryMsg = document.createElement('div');
        retryMsg.className='message assistant-message warning visible';
        retryMsg.textContent = `${data.error || 'Servicio temporalmente sobrecargado'}. Reintentando automáticamente en ${Math.ceil(data.retry_after/1000)} segundos...`;
        messagesDiv.appendChild(retryMsg);
        scrollToBottom();
        
        const timeoutId = setTimeout(() => {
          retryMsg.remove();
          sendMessage(question, retryCount + 1);
        }, data.retry_after);
        
        retryTimeouts.push(timeoutId);
        return;
      }

      const a = document.createElement('div');
      a.className='message assistant-message visible';
      messagesDiv.appendChild(a);

      if(data && data.ok === false){
        a.innerHTML = `<p class="error">Error: ${data.error || 'desconocido'}</p>`;
        scrollToBottom(); 
        return;
      }

      // USAR MARKDOWN PARA RENDERIZAR LA RESPUESTA
      const resultHTML = renderMarkdown(data.result_text);
      const processHTML = renderMarkdown(data.process_text || '');
      const { id, html } = buildBlock(resultHTML, processHTML, detectedLanguage);
      a.innerHTML = html;

      const header = a.querySelector('.process-header');
      header?.addEventListener('click', ()=>toggleProcess(id));

      scrollToBottom();

    }catch(err){
      console.error(err);
      typing.remove();
      
      if(err.name === 'AbortError' && retryCount < 2){
        const retryMsg = document.createElement('div');
        retryMsg.className='message assistant-message warning visible';
        retryMsg.textContent = 'Tiempo de espera agotado. Reintentando...';
        messagesDiv.appendChild(retryMsg);
        scrollToBottom();
        
        setTimeout(() => {
          retryMsg.remove();
          sendMessage(question, retryCount + 1);
        }, 2000);
        return;
      }
      
      const e = document.createElement('div');
      e.className='message assistant-message error visible';
      e.textContent = 'No pudimos procesar la consulta. ' + 
        (err.name==='AbortError'?'Tiempo de espera agotado.':(err.message||'Error'));
      messagesDiv.appendChild(e);
      scrollToBottom();
    }finally{
      isLoading=false; 
      sendBtn.disabled=false;
    }
  }

  window.addEventListener('beforeunload', () => {
    retryTimeouts.forEach(t => clearTimeout(t));
  });

  sendBtn.addEventListener('click', () => sendMessage());
  input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });
  input.focus();
  </script>
</body>
</html>