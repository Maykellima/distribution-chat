<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Distribution Chat</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{ --black-90:rgba(0,0,0,.9); --black-80:rgba(0,0,0,.8); --border:rgba(0,0,0,.2); --bg:#fff; }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center;align-items:center;color:#222}
    .container{width:640px;padding:40px 20px}
    
    .messages{min-height:400px;max-height:70vh;overflow-y:auto;margin-bottom:40px;padding:20px 0;scrollbar-width:none;-ms-overflow-style:none}
    .messages::-webkit-scrollbar{display:none}
    .message{margin-bottom:14px;margin-left:60px;position:relative;animation:fadeIn .25s ease}
    .user-message{font-size:18px;color:#222;font-weight:600;text-transform:uppercase;letter-spacing:.02em;max-width:520px}
    .user-message::before{content:'';position:absolute;left:-40px;top:5px;width:12px;height:12px;background:#000;border-radius:50%}
    .assistant-message{font-size:15px;color:#2b2b2b;line-height:1.65;max-width:520px;opacity:0;transform:translateY(20px);transition:all 0.4s ease-out}
    .assistant-message.visible{opacity:1;transform:translateY(0)}
    .assistant-message.error{color:#d93025;background:#fce8e6;padding:12px;border-radius:8px}
    .assistant-message strong{font-weight:700;color:#000}
    .typing-indicator{margin-left:60px;height:18px;color:var(--black-80);font-size:13px}
    
    .input-container{position:relative}
    .input-field{width:100%;padding:20px 60px 20px 24px;border:2px solid #e5e5e5;border-radius:50px;font-size:16px;color:#222;background:#fff;outline:none;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .input-field:focus{border-color:#666;box-shadow:0 4px 16px rgba(0,0,0,.12)}
    .input-field:disabled{background:#f5f5f5;cursor:not-allowed}
    .input-field::placeholder{color:#999;font-weight:400}
    .send-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:44px;height:44px;border:none;border-radius:50%;background:#111;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .send-button:hover:not(:disabled){background:#000;transform:translateY(-50%) scale(1.04);box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .send-button:disabled{background:#f0f0f0;color:#aaa;cursor:not-allowed;box-shadow:none;transform:translateY(-50%)}
    .send-button svg{width:20px;height:20px;transform:rotate(-90deg)}
    
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="messages" id="messages"></div>
    
    <div class="input-container">
      <input type="text" class="input-field" id="input" 
             placeholder="Escribe tu pregunta..." 
             autocomplete="off" maxlength="500"/>
      <button class="send-button" id="sendBtn" aria-label="Enviar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 12l14 0M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

<script>
// Configuración simple
const SUPABASE_URL = 'https://tzoiscozwjnuxmecwtqi.supabase.co';
const messagesDiv = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
let isLoading = false;

// Función para enviar mensaje
async function sendMessage() {
  const question = input.value.trim();
  if (!question || isLoading) return;

  // Mostrar mensaje del usuario
  const userMsg = document.createElement('div');
  userMsg.className = 'message user-message';
  userMsg.textContent = question.toUpperCase();
  messagesDiv.appendChild(userMsg);

  // Limpiar input
  input.value = '';
  input.focus();
  isLoading = true;
  sendBtn.disabled = true;

  // Indicador de carga
  const typing = document.createElement('div');
  typing.className = 'typing-indicator';
  typing.textContent = 'Procesando...';
  messagesDiv.appendChild(typing);
  scrollToBottom();

  try {
    // Llamada al backend SIN AUTENTICACIÓN
    const response = await fetch(`${SUPABASE_URL}/functions/v1/chat-query`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ question })
    });
    
    const data = await response.json();
    typing.remove();

    // Crear respuesta
    const assistantMsg = document.createElement('div');
    assistantMsg.className = 'message assistant-message';
    
    if (data.success) {
      assistantMsg.textContent = data.answer?.result || data.answer || 'Sin respuesta';
    } else {
      assistantMsg.classList.add('error');
      assistantMsg.textContent = data.message || 'Error al procesar';
    }
    
    messagesDiv.appendChild(assistantMsg);
    
    // Animación
    requestAnimationFrame(() => {
      assistantMsg.classList.add('visible');
      scrollToBottom();
    });

  } catch (err) {
    console.error('Error:', err);
    typing.remove();
    
    const errorMsg = document.createElement('div');
    errorMsg.className = 'message assistant-message error';
    errorMsg.textContent = 'Error de conexión: ' + err.message;
    messagesDiv.appendChild(errorMsg);
    scrollToBottom();
  } finally {
    isLoading = false;
    sendBtn.disabled = false;
  }
}

// Función para scroll
function scrollToBottom() {
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendMessage();
  }
});

// Inicialización
console.log('Chat iniciado - Sin autenticación');
input.focus();
</script>
</body>
</html>