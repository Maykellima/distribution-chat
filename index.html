<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Distribution Chat - Secure</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{ --black-90:rgba(0,0,0,.9); --black-80:rgba(0,0,0,.8); --border:rgba(0,0,0,.2); --bg:#fff; }
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center;align-items:center;color:#222}
.container{width:640px;padding:40px 0}

/* Status bar para mostrar informaci√≥n de sesi√≥n */
.status-bar{
    background:#f8f9fa;
    border:1px solid #e9ecef;
    border-radius:8px;
    padding:12px 16px;
    margin-bottom:20px;
    font-size:13px;
    color:#6c757d;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.status-bar.error{background:#fff5f5;border-color:#fed7d7;color:#c53030}
.status-bar.success{background:#f0fff4;border-color:#c6f6d5;color:#22543d}

.messages{min-height:400px;max-height:70vh;overflow-y:auto;margin-bottom:40px;padding:20px 0;scrollbar-width:none;-ms-overflow-style:none}
.messages::-webkit-scrollbar{display:none}
.message{margin-bottom:14px;margin-left:60px;position:relative;animation:fadeIn .25s ease}
.user-message{font-size:18px;color:#222;font-weight:600;text-transform:uppercase;letter-spacing:.02em;max-width:520px}
.user-message::before{content:'';position:absolute;left:-40px;top:5px;width:12px;height:12px;background:#000;border-radius:50%}
.assistant-message{font-size:15px;color:#2b2b2b;line-height:1.65;max-width:520px;opacity:0;transform:translateY(20px);transition:all 0.4s ease-out}
.assistant-message.visible{opacity:1;transform:translateY(0)}
.assistant-message strong{font-weight:700;color:#000}
.assistant-message ul,.assistant-message ol{margin:8px 0 8px 22px}
.assistant-message li{margin:4px 0}
.proc-sep{margin:16px 0;border:0;border-top:1px solid var(--black-90)}
.process-section{margin-top:10px}
.process-header{font-size:15px;font-weight:700;color:#111;margin:6px 0 8px;display:flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
.process-arrow{font-size:13px;display:inline-block;min-width:14px}
.process-content{display:none;padding-top:8px;font-size:13px;color:#444;line-height:1.7}
.process-content.visible{display:block}
.typing-indicator{margin-left:60px;height:18px;color:var(--black-80);font-size:13px}
.input-container{position:relative}
.input-field{width:100%;padding:20px 60px 20px 24px;border:2px solid #e5e5e5;border-radius:50px;font-size:16px;color:#222;background:#fff;outline:none;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.input-field:focus{border-color:#666;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.input-field::placeholder{color:#999;font-weight:400}
.send-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:44px;height:44px;border:none;border-radius:50%;background:#111;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.send-button:hover:not(:disabled){background:#000;transform:translateY(-50%) scale(1.04);box-shadow:0 4px 12px rgba(0,0,0,.25)}
.send-button:disabled{background:#f0f0f0;color:#aaa;cursor:not-allowed;box-shadow:none;transform:translateY(-50%)}
.send-button svg{width:20px;height:20px;transform:rotate(-90deg)}

/* Indicador de conexi√≥n */
.connection-status{
    position:fixed;
    top:20px;
    right:20px;
    padding:8px 16px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
}
.connection-status.connected{background:#22543d;color:white}
.connection-status.disconnected{background:#c53030;color:white}
.connection-status.connecting{background:#d69e2e;color:white}

@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="container">
    <!-- Status bar para informaci√≥n de sesi√≥n -->
    <div class="status-bar" id="statusBar">
        <span>Inicializando sesi√≥n...</span>
        <span id="sessionInfo"></span>
    </div>

    <div class="messages" id="messages"></div>
    <div class="input-container">
        <input type="text" class="input-field" id="input" 
               placeholder="¬øEn qu√© puedo ayudarte?" autocomplete="off"/>
        <button class="send-button" id="sendBtn" aria-label="Enviar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12l14 0M12 5l7 7-7 7"/>
            </svg>
        </button>
    </div>
</div>

<!-- Indicador de conexi√≥n -->
<div class="connection-status connecting" id="connectionStatus">Conectando...</div>

<script>
// Configuraci√≥n segura - Solo endpoint de backend
const API_BASE_URL = '/functions/v1'; // Cambiar por tu URL de Supabase Edge Functions

console.log('üîí Iniciando Distribution Chat V2 - Modo Seguro');

const messagesDiv = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const statusBar = document.getElementById('statusBar');
const sessionInfo = document.getElementById('sessionInfo');
const connectionStatus = document.getElementById('connectionStatus');

let currentSessionId = null;
let isLoading = false;
let requestCount = 0;

// Sistema de gesti√≥n de sesiones
class SecureSessionManager {
    constructor() {
        this.sessionId = null;
        this.isInitialized = false;
    }

    async initialize() {
        try {
            updateConnectionStatus('connecting', 'Estableciendo sesi√≥n segura...');
            
            // Intentar recuperar sesi√≥n existente
            const existingSessionId = localStorage.getItem('secure_chat_session');
            
            if (existingSessionId && this.isValidSessionFormat(existingSessionId)) {
                // Verificar si la sesi√≥n sigue siendo v√°lida
                const isValid = await this.validateExistingSession(existingSessionId);
                if (isValid) {
                    this.sessionId = existingSessionId;
                    console.log('‚úÖ Sesi√≥n existente recuperada:', existingSessionId);
                    updateSessionInfo('Sesi√≥n recuperada', 'success');
                    updateConnectionStatus('connected', 'Conectado');
                    this.isInitialized = true;
                    return;
                }
            }

            // Crear nueva sesi√≥n
            await this.createNewSession();
        } catch (error) {
            console.error('‚ùå Error inicializando sesi√≥n:', error);
            updateSessionInfo('Error de conexi√≥n', 'error');
            updateConnectionStatus('disconnected', 'Error de conexi√≥n');
        }
    }

    async createNewSession() {
        const response = await fetch(`${API_BASE_URL}/new-session`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        this.sessionId = data.sessionId;
        
        // Guardar en localStorage de forma segura
        localStorage.setItem('secure_chat_session', this.sessionId);
        
        console.log('üÜî Nueva sesi√≥n creada:', this.sessionId);
        updateSessionInfo('Nueva sesi√≥n iniciada', 'success');
        updateConnectionStatus('connected', 'Conectado');
        this.isInitialized = true;
    }

    async validateExistingSession(sessionId) {
        try {
            // Hacer una consulta de prueba para verificar si la sesi√≥n es v√°lida
            const response = await fetch(`${API_BASE_URL}/chat-query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: 'test_session_validation',
                    sessionId: sessionId
                })
            });

            return response.ok;
        } catch {
            return false;
        }
    }

    isValidSessionFormat(sessionId) {
        return sessionId && sessionId.startsWith('session_') && sessionId.length > 20;
    }

    getSessionId() {
        return this.sessionId;
    }

    isReady() {
        return this.isInitialized && this.sessionId;
    }

    // M√©todo para limpiar sesi√≥n (por si es necesario)
    clearSession() {
        localStorage.removeItem('secure_chat_session');
        this.sessionId = null;
        this.isInitialized = false;
    }
}

// Instancia global del gestor de sesiones
const sessionManager = new SecureSessionManager();

// Funciones de UI
function updateSessionInfo(message, type = 'normal') {
    sessionInfo.textContent = message;
    statusBar.className = `status-bar ${type}`;
}

function updateConnectionStatus(status, message) {
    connectionStatus.className = `connection-status ${status}`;
    connectionStatus.textContent = message;
}

// Formateo b√°sico de markdown (simplificado)
function formatBasicContent(content) {
    let formatted = content
        .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/(?<!\*)\*([^\*]+)\*(?!\*)/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');

    return formatted;
}

// Parser de respuestas estructuradas (simplificado)
function parseStructuredResponse(text) {
    const normalized = text.trim().replace(/\u00A0/g, ' ');
    
    let resultMatch = normalized.match(/\[RESULTADO\]([\s\S]*?)\[\/RESULTADO\]/i);
    let processMatch = normalized.match(/\[PROCESO\]([\s\S]*?)\[\/PROCESO\]/i);
    
    if (resultMatch) {
        return {
            hasStructure: true,
            result: resultMatch[1].trim(),
            process: processMatch ? processMatch[1].trim() : 'No se proporcion√≥ informaci√≥n del proceso.'
        };
    }
    
    return {
        hasStructure: false,
        result: normalized,
        process: ''
    };
}

// Construcci√≥n de mensajes estructurados
function buildStructuredMessage(resultText, processText) {
    const id = 'm' + Date.now() + Math.floor(Math.random() * 1e4);
    const html = `
        <div class="result-section" id="result-${id}"></div>
        <hr class="proc-sep">
        <div class="process-section">
            <div class="process-header" data-target="${id}">
                <span>Proceso</span><span class="process-arrow" id="arrow-${id}">‚ñº</span>
            </div>
            <div class="process-content" id="process-${id}">
                ${formatBasicContent(processText)}
            </div>
        </div>`;
    return { id, html };
}

function toggleProcess(id) {
    const proc = document.getElementById('process-' + id);
    const arrow = document.getElementById('arrow-' + id);
    if (!proc) return;
    const vis = proc.classList.toggle('visible');
    arrow.textContent = vis ? '‚ñ≤' : '‚ñº';
}

function showContentWithAnimation(text, element, onComplete) {
    const formattedHTML = formatBasicContent(text);
    element.innerHTML = formattedHTML;
    
    if (onComplete) {
        setTimeout(onComplete, 50);
    }
}

function scrollToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Funci√≥n principal de env√≠o (simplificada y segura)
async function sendMessage() {
    const originalQuery = input.value.trim();
    if (!originalQuery || isLoading) return;

    // Verificar que la sesi√≥n est√© lista
    if (!sessionManager.isReady()) {
        updateSessionInfo('Sesi√≥n no v√°lida, reinicializando...', 'error');
        await sessionManager.initialize();
        if (!sessionManager.isReady()) {
            updateSessionInfo('Error de conexi√≥n', 'error');
            return;
        }
    }

    // Mostrar mensaje del usuario
    const userMsg = document.createElement('div');
    userMsg.className = 'message user-message';
    userMsg.textContent = originalQuery.toUpperCase();
    messagesDiv.appendChild(userMsg);

    input.value = '';
    input.focus();
    isLoading = true;
    sendBtn.disabled = true;
    requestCount++;

    // Mostrar indicador de carga
    const typing = document.createElement('div');
    typing.className = 'typing-indicator';
    typing.textContent = 'procesando consulta de forma segura...';
    messagesDiv.appendChild(typing);
    scrollToBottom();

    // Actualizar info de sesi√≥n
    updateSessionInfo(`Consulta #${requestCount} en proceso...`, 'normal');

    try {
        console.log('üîí Enviando consulta segura:', originalQuery);
        
        const response = await fetch(`${API_BASE_URL}/chat-query`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question: originalQuery,
                sessionId: sessionManager.getSessionId()
            })
        });

        console.log('üì° Response status:', response.status);

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('üì® Response data:', data);

        typing.remove();

        // Crear mensaje de respuesta
        const assistantMsg = document.createElement('div');
        assistantMsg.className = 'message assistant-message';
        messagesDiv.appendChild(assistantMsg);

        const fullResponse = data.answer || 'Error al procesar la respuesta.';
        const parsedResponse = parseStructuredResponse(fullResponse);

        if (parsedResponse.hasStructure) {
            const { id, html } = buildStructuredMessage(parsedResponse.result, parsedResponse.process);
            assistantMsg.innerHTML = html;
            const resultEl = document.getElementById('result-' + id);
            
            showContentWithAnimation(parsedResponse.result, resultEl, () => {
                scrollToBottom();
            });
            
            const header = assistantMsg.querySelector(`.process-header[data-target="${id}"]`);
            header.addEventListener('click', () => toggleProcess(id));
            
            requestAnimationFrame(() => {
                assistantMsg.classList.add('visible');
            });
        } else {
            assistantMsg.innerHTML = formatBasicContent(fullResponse);
            requestAnimationFrame(() => {
                assistantMsg.classList.add('visible');
            });
        }
        
        scrollToBottom();

        // Actualizar informaci√≥n de sesi√≥n
        updateSessionInfo(`Consulta completada en ${data.processingTime || 0}ms`, 'success');
        
    } catch (err) {
        console.error('‚ùå Error en consulta:', err);
        typing.remove();
        
        const errorMsg = document.createElement('div');
        errorMsg.className = 'message assistant-message';
        errorMsg.innerHTML = `<strong>Error de conexi√≥n:</strong> ${err.message}<br><small>Por favor intenta nuevamente.</small>`;
        messagesDiv.appendChild(errorMsg);
        
        updateSessionInfo('Error en consulta', 'error');
        
        // Si es error 401/403, reinicializar sesi√≥n
        if (err.message.includes('401') || err.message.includes('403')) {
            console.log('üîÑ Reinicializando sesi√≥n por error de autenticaci√≥n...');
            sessionManager.clearSession();
            await sessionManager.initialize();
        }
    } finally {
        isLoading = false;
        sendBtn.disabled = false;
    }
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// Mostrar informaci√≥n de sesi√≥n en el status bar
input.addEventListener('focus', () => {
    if (sessionManager.isReady()) {
        const shortId = sessionManager.getSessionId().split('_')[2].substring(0, 8);
        sessionInfo.textContent = `ID: ${shortId}`;
    }
});

input.addEventListener('blur', () => {
    sessionInfo.textContent = '';
});

// Inicializaci√≥n segura
async function initializeSecureChat() {
    try {
        await sessionManager.initialize();
        input.focus();
        console.log('üîí Distribution Chat V2 - Listo y seguro');
        
        // Mensaje de bienvenida
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'message assistant-message visible';
        welcomeMsg.innerHTML = '<strong>Sistema seguro iniciado.</strong> Puedes realizar tus consultas de forma protegida.';
        messagesDiv.appendChild(welcomeMsg);
    } catch (error) {
        console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
        updateSessionInfo('Error cr√≠tico del sistema', 'error');
        updateConnectionStatus('disconnected', 'Sin conexi√≥n');
    }
}

// Inicializar cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', initializeSecureChat);
</script>
</body>
</html>