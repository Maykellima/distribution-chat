<!-- index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Distribution Chat</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--black-90:rgba(0,0,0,.9);--black-80:rgba(0,0,0,.8);--border:rgba(0,0,0,.2);--bg:#fff}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center;align-items:center;color:#222}
    .container{width:640px;padding:40px 0}
    .messages{min-height:400px;max-height:70vh;overflow-y:auto;margin-bottom:40px;padding:20px 0;scrollbar-width:none;-ms-overflow-style:none}
    .messages::-webkit-scrollbar{display:none}
    .message{margin-bottom:14px;margin-left:60px;position:relative;animation:fadeIn .25s ease}
    .user-message{font-size:18px;color:#222;font-weight:600;text-transform:uppercase;letter-spacing:.02em;max-width:520px}
    .user-message::before{content:'';position:absolute;left:-40px;top:5px;width:12px;height:12px;background:#000;border-radius:50%}
    .assistant-message{font-size:15px;color:#2b2b2b;line-height:1.65;max-width:520px;opacity:0;transform:translateY(20px);transition:all .4s ease-out}
    .assistant-message.visible{opacity:1;transform:translateY(0)}
    .assistant-message strong{font-weight:700;color:#000}
    .assistant-message ul,.assistant-message ol{margin:8px 0 8px 22px}
    .assistant-message li{margin:4px 0}
    .proc-sep{margin:16px 0;border:0;border-top:1px solid var(--black-90)}
    .process-section{margin-top:10px}
    .process-header{font-size:15px;font-weight:700;color:#111;margin:6px 0 8px;display:flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
    .process-arrow{font-size:13px;display:inline-block;min-width:14px}
    .process-content{display:none;padding-top:8px;font-size:13px;color:#444;line-height:1.7}
    .process-content.visible{display:block}
    .typing-indicator{margin-left:60px;height:18px;color:var(--black-80);font-size:13px}
    .input-container{position:relative}
    .input-field{width:100%;padding:20px 60px 20px 24px;border:2px solid #e5e5e5;border-radius:50px;font-size:16px;color:#222;background:#fff;outline:none;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .input-field:focus{border-color:#666;box-shadow:0 4px 16px rgba(0,0,0,.12)}
    .input-field::placeholder{color:#999;font-weight:400}
    .send-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:44px;height:44px;border:none;border-radius:50%;background:#111;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .send-button:hover:not(:disabled){background:#000;transform:translateY(-50%) scale(1.04);box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .send-button:disabled{background:#f0f0f0;color:#aaa;cursor:not-allowed;box-shadow:none;transform:translateY(-50%)}
    .send-button svg{width:20px;height:20px;transform:rotate(-90deg)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;vertical-align:middle}
    .st-1{background:#2ecc71}.st-0{background:#bdc3c7}.st--1{background:#e74c3c}
  </style>
</head>
<body>
  <div class="container">
    <div class="messages" id="messages"></div>
    <div class="input-container">
      <input type="text" class="input-field" id="input" placeholder="Escribe tu consulta..." autocomplete="off"/>
      <button class="send-button" id="sendBtn" aria-label="Enviar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12l14 0M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

<script>
// ===== Config =====
// En pruebas puedes llamar a la Function vía el dominio de Supabase (mismo que ya usabas)
const SUPABASE_URL = 'https://tzoiscozwjnuxmecwtqi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6b2lzY296d2pudXhtZWN3dHFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDQ4MTEsImV4cCI6MjA3MTE4MDgxMX0.67idmsow4i51CLKf3a07UGYvHOepZ50tryvyJH3pKaY';

const messagesDiv = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');

let isLoading = false;

// ===== Utils de UI =====
function scrollToBottom(){ messagesDiv.scrollTop = messagesDiv.scrollHeight; }
function basicFormat(s){ return s.replace(/\n{2,}/g, '\n\n').replace(/\n/g,'<br>'); }

function buildStructuredBlock(resultHTML, processHTML){
  const id='m'+Date.now()+Math.floor(Math.random()*1e4);
  const html = `
    <div class="result-section" id="result-${id}">${resultHTML}</div>
    <hr class="proc-sep">
    <div class="process-section">
      <div class="process-header" data-target="${id}">
        <span>Process</span><span class="process-arrow" id="arrow-${id}">▼</span>
      </div>
      <div class="process-content" id="process-${id}">${processHTML}</div>
    </div>`;
  return { id, html };
}
function toggleProcess(id){
  const proc=document.getElementById('process-'+id);
  const arrow=document.getElementById('arrow-'+id);
  if(!proc)return;
  const vis=proc.classList.toggle('visible');
  arrow.textContent=vis?'▲':'▼';
}

// ===== Render a partir de "structured" =====
function renderFromStructured(structured, fallbackResultText){
  if(structured && Array.isArray(structured.items) && structured.items.length){
    const title = `<p><strong>Resultados (${structured.items.length})</strong></p>`;
    const list = structured.items.map((it, i)=>{
      const sv = typeof it.status_value === 'number' ? it.status_value : null;
      const label = it.status_label || '';
      const dotClass = sv === 1 ? 'st-1' : (sv === -1 ? 'st--1' : 'st-0');
      const name = it.name ? `<strong>${it.name}</strong>` : '';
      const role = it.role ? ` – ${it.role}` : '';
      return `<li><span class="status-dot ${dotClass}"></span>${name}${role}${label ? ` – ${label}` : ''}</li>`;
    }).join('');
    const note = structured.note ? `<br><strong>Nota:</strong> ${basicFormat(structured.note)}` : '';
    return `${title}<ol>${list}</ol>${note}`;
  }
  // fallback: texto plano
  return basicFormat(fallbackResultText || '—');
}

// ===== Conversation Id =====
function getConversationId(){
  const k='chat_conversation_id';
  let id = localStorage.getItem(k);
  if(!id){ id = crypto.randomUUID(); localStorage.setItem(k,id); }
  return id;
}

// ===== Envío =====
async function sendMessage(){
  const question = input.value.trim();
  if(!question || isLoading) return;

  const u = document.createElement('div');
  u.className='message user-message';
  u.textContent=question.toUpperCase();
  messagesDiv.appendChild(u);

  input.value=''; input.focus();
  isLoading=true; sendBtn.disabled=true;

  const typing=document.createElement('div');
  typing.className='typing-indicator';
  typing.textContent='thinking…';
  messagesDiv.appendChild(typing);
  scrollToBottom();

  try{
    const r = await fetch(`${SUPABASE_URL}/functions/v1/chat-query`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'apikey':SUPABASE_ANON_KEY,
        'Authorization':`Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        question,
        conversation_id: getConversationId()
      })
    });

    const data = await r.json();
    typing.remove();

    const a = document.createElement('div');
    a.className='message assistant-message';
    messagesDiv.appendChild(a);

    const resultHTML = renderFromStructured(data.structured, data.result_text);
    const processHTML = basicFormat(data.process_text || '');

    const { id, html } = buildStructuredBlock(resultHTML, processHTML);
    a.innerHTML = html;

    const header = a.querySelector(`.process-header[data-target="${id}"]`);
    header.addEventListener('click', ()=>toggleProcess(id));

    requestAnimationFrame(()=>a.classList.add('visible'));
    scrollToBottom();

  }catch(err){
    typing.remove();
    const e = document.createElement('div');
    e.className='message assistant-message';
    e.textContent='Error al conectar con el servidor: ' + err.message;
    messagesDiv.appendChild(e);
  }finally{
    isLoading=false; sendBtn.disabled=false;
  }
}

// Eventos
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });
input.focus();
</script>
</body>
</html>
