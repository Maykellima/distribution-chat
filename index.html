<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Distribution Chat</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{ --black-90:rgba(0,0,0,.9); --black-80:rgba(0,0,0,.8); --border:rgba(0,0,0,.2); --bg:#fff; }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);min-height:100vh;display:flex;justify-content:center;align-items:center;color:#222}
    .container{width:640px;padding:40px 0}
    
    /* === LOGIN STYLES === */
    .login-container{text-align:center;padding:60px 40px}
    .login-title{font-size:32px;font-weight:700;margin-bottom:12px;color:#111}
    .login-subtitle{font-size:18px;color:#666;margin-bottom:40px}
    .login-button{background:#4285f4;color:#fff;border:none;border-radius:8px;padding:16px 32px;font-size:16px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:12px;transition:all 0.2s ease;text-decoration:none}
    .login-button:hover{background:#3367d6;transform:translateY(-1px);box-shadow:0 4px 12px rgba(66,133,244,0.3)}
    .login-button svg{width:20px;height:20px}
    
    .user-info{position:absolute;top:20px;right:20px;display:flex;align-items:center;gap:12px;background:#f8f9fa;padding:8px 16px;border-radius:24px;font-size:14px}
    .user-email{color:#666;font-weight:500}
    .logout-btn{background:none;border:none;color:#666;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:background 0.2s}
    .logout-btn:hover{background:#e8eaed}
    
    .loading{text-align:center;padding:40px;color:#666}
    .error{text-align:center;padding:40px;color:#d93025;background:#fce8e6;border-radius:8px;margin:20px}
    
    /* === CHAT STYLES === */
    .chat-container{display:none}
    .chat-container.visible{display:block}
    .messages{min-height:400px;max-height:70vh;overflow-y:auto;margin-bottom:40px;padding:20px 0;scrollbar-width:none;-ms-overflow-style:none}
    .messages::-webkit-scrollbar{display:none}
    .message{margin-bottom:14px;margin-left:60px;position:relative;animation:fadeIn .25s ease}
    .user-message{font-size:18px;color:#222;font-weight:600;text-transform:uppercase;letter-spacing:.02em;max-width:520px}
    .user-message::before{content:'';position:absolute;left:-40px;top:5px;width:12px;height:12px;background:#000;border-radius:50%}
    .assistant-message{font-size:15px;color:#2b2b2b;line-height:1.65;max-width:520px;opacity:0;transform:translateY(20px);transition:all 0.4s ease-out}
    .assistant-message.visible{opacity:1;transform:translateY(0)}
    .assistant-message strong{font-weight:700;color:#000}
    .assistant-message ul,.assistant-message ol{margin:8px 0 8px 22px}
    .assistant-message li{margin:4px 0}
    .proc-sep{margin:16px 0;border:0;border-top:1px solid var(--black-90)}
    .process-section{margin-top:10px}
    .process-header{font-size:15px;font-weight:700;color:#111;margin:6px 0 8px;display:flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
    .process-arrow{font-size:13px;display:inline-block;min-width:14px}
    .process-content{display:none;padding-top:8px;font-size:13px;color:#444;line-height:1.7}
    .process-content.visible{display:block}
    .typing-indicator{margin-left:60px;height:18px;color:var(--black-80);font-size:13px}
    .input-container{position:relative}
    .input-field{width:100%;padding:20px 60px 20px 24px;border:2px solid #e5e5e5;border-radius:50px;font-size:16px;color:#222;background:#fff;outline:none;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .input-field:focus{border-color:#666;box-shadow:0 4px 16px rgba(0,0,0,.12)}
    .input-field::placeholder{color:#999;font-weight:400}
    .send-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:44px;height:44px;border:none;border-radius:50%;background:#111;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .send-button:hover:not(:disabled){background:#000;transform:translateY(-50%) scale(1.04);box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .send-button:disabled{background:#f0f0f0;color:#aaa;cursor:not-allowed;box-shadow:none;transform:translateY(-50%)}
    .send-button svg{width:20px;height:20px;transform:rotate(-90deg)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      Cargando...
    </div>
    
    <!-- Error State -->
    <div id="error" class="error" style="display:none">
      <h3>Error de Configuración</h3>
      <p>No se pudo inicializar el sistema de autenticación.</p>
    </div>
    
    <!-- Login State -->
    <div id="login" class="login-container" style="display:none">
      <h1 class="login-title">Distribution Chat</h1>
      <p class="login-subtitle">✨</p>
      <button id="loginBtn" class="login-button">
        <svg viewBox="0 0 24 24">
          <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continuar con Google
      </button>
    </div>
    
    <!-- Chat State -->
    <div id="chat" class="chat-container">
      <div class="user-info" id="userInfo" style="display:none">
        <span class="user-email" id="userEmail"></span>
        <button class="logout-btn" id="logoutBtn">Salir</button>
      </div>
      
      <div class="messages" id="messages"></div>
      <div class="input-container">
        <input type="text" class="input-field" id="input" placeholder="Hello, how can I help you?" autocomplete="off"/>
        <button class="send-button" id="sendBtn" aria-label="Enviar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12l14 0M12 5l7 7-7 7"/></svg>
        </button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// CONFIGURACIÓN DE SUPABASE
const SUPABASE_URL = 'https://tzoiscozwjnuxmecwtqi.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6b2lzY296d2pudXhtZWN3dHFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDQ4MTEsImV4cCI6MjA3MTE4MDgxMX0.67idmsow4i51CLKf3a07UGYvHOepZ50tryvyJH3pKaY';

// Verificar que Supabase esté disponible
if (!window.supabase) {
  console.error('Supabase no se cargó correctamente');
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
} else {
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ELEMENTOS DEL DOM
  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const loginEl = document.getElementById('login');
  const chatEl = document.getElementById('chat');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userInfoEl = document.getElementById('userInfo');
  const userEmailEl = document.getElementById('userEmail');
  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let isLoading = false;

  // GESTIÓN DE ESTADOS
  function showLoading() {
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    loginEl.style.display = 'none';
    chatEl.classList.remove('visible');
  }

  function showError(message) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'block';
    loginEl.style.display = 'none';
    chatEl.classList.remove('visible');
    errorEl.querySelector('p').textContent = message || 'Error desconocido';
  }

  function showLogin() {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'none';
    loginEl.style.display = 'block';
    chatEl.classList.remove('visible');
  }

  function showChat(user) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'none';
    loginEl.style.display = 'none';
    chatEl.classList.add('visible');
    
    userInfoEl.style.display = 'flex';
    userEmailEl.textContent = user.email;
    input.focus();
  }

  // AUTENTICACIÓN
  async function checkAuthState() {
    try {
      console.log('Verificando estado de autenticación...');
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        console.error('Error verificando sesión:', error);
        showLogin();
        return;
      }
      
      if (session?.user) {
        console.log('Usuario ya autenticado:', session.user.email);
        
        // Verificar si tiene acceso autorizado
        const hasAccess = await checkUserAccess(session.user);
        if (hasAccess) {
          currentUser = session.user;
          showChat(session.user);
        } else {
          await supabase.auth.signOut();
          showError('No tienes autorización para acceder a este sistema. Contacta al administrador.');
        }
      } else {
        console.log('No hay sesión activa');
        showLogin();
      }
    } catch (err) {
      console.error('Error en verificación de autenticación:', err);
      showError('Error al verificar autenticación');
    }
  }

  async function checkUserAccess(user) {
  // Permitir solo emails de theagilemonkeys.com y theam.io
  const allowedDomains = ['@theagilemonkeys.com', '@theam.io'];
  const isAllowed = allowedDomains.some(domain => user.email.endsWith(domain));
  
  console.log(`Verificando acceso para ${user.email}: ${isAllowed ? 'PERMITIDO' : 'DENEGADO'}`);
  
  return isAllowed;
}
      
      console.log('Usuario autorizado:', data.name, '(' + data.role + ')');
      return true;
    } catch (err) {
      console.error('Error verificando acceso:', err);
      return false;
    }
  }

  async function signInWithGoogle() {
    try {
      loginBtn.textContent = 'Conectando...';
      loginBtn.disabled = true;
      
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin
        }
      });
      
      if (error) {
        console.error('Error en login:', error);
        showError('Error al iniciar sesión: ' + error.message);
        loginBtn.textContent = 'Continuar con Google';
        loginBtn.disabled = false;
      }
    } catch (err) {
      console.error('Error en signInWithGoogle:', err);
      showError('Error al conectar con Google');
      loginBtn.textContent = 'Continuar con Google';
      loginBtn.disabled = false;
    }
  }

  async function signOut() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error en logout:', error);
      }
      currentUser = null;
      messagesDiv.innerHTML = '';
      showLogin();
    } catch (err) {
      console.error('Error en signOut:', err);
    }
  }

  // MANEJO DE CAMBIOS DE AUTENTICACIÓN
  supabase.auth.onAuthStateChange(async (event, session) => {
    console.log('Auth state changed:', event, session?.user?.email);
    
    if (event === 'SIGNED_IN' && session?.user) {
      const hasAccess = await checkUserAccess(session.user);
      if (hasAccess) {
        currentUser = session.user;
        showChat(session.user);
      } else {
        await supabase.auth.signOut();
        showError('No tienes autorización para acceder a este sistema.');
      }
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      messagesDiv.innerHTML = '';
      showLogin();
    }
  });

  /* ===== CHAT FUNCTIONALITY ===== */
  class ConversationMemory{
    constructor(){this.context=null;this.DUR=10*60*1000}
    update(q,a){this.context={lastQuery:q,lastAnswer:a,entities:this.extract(q,a),ts:Date.now()}}
    extract(q,a){const c=(q+' '+a).toLowerCase();return {projects:this.extractProjects(c),people:this.extractPeople(a)}}
    extractProjects(txt){const known=['dataverse','delta','sid','hornblower','data','al findr','solutran','control plane','infrastructure team','zeta'];return known.filter(p=>txt.includes(p))}
    extractPeople(t){const re=/[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+)+/g;return t.match(re)||[]}
    enhance(q){
      if(!this.context || Date.now()-this.context.ts>this.DUR) return q
      const lq=q.toLowerCase()
      if((lq.includes('ellos')||lq.includes('estos')) && this.context.entities.people.length) return q+` (contexto: ${this.context.entities.people.join(', ')})`
      if((lq.includes('ese proyecto')||lq.includes('el proyecto')) && this.context.entities.projects.length) return q+` (contexto: proyecto ${this.context.entities.projects[0]})`
      return q
    }
  }
  const memory=new ConversationMemory();

  function formatBasicContent(content){
    let f = content
      .replace(/^### (.*?)$/gm,'<h3>$1</h3>')
      .replace(/^## (.*?)$/gm,'<h2>$1</h2>')
      .replace(/^# (.*?)$/gm,'<h1>$1</h1>')
      .replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code class="language-$1">$2</code></pre>')
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g,'<em>$1</em>')
      .replace(/`(.*?)`/g,'<code>$1</code>')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>')
      .replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>')
      .replace(/^[\*\-\+] (.+)$/gm,'<li>$1</li>')
      .replace(/\n/g,'<br>');
    f = f.replace(/(<li>.*?<\/li>(?:<br>)?)+/g, m => '<ul>' + m.replace(/<br>/g,'') + '</ul>');
    f = f.replace(/(<br>){2,}/g,'<br><br>');
    return f;
  }

  function formatResultRich(text){
    let body = text.trim().replace(/\u00A0/g,' ');
    let note = '';

    const nIdx = body.search(/\bNota:/i);
    if (nIdx >= 0){
      note = body.slice(nIdx).replace(/^.*?\bNota:\s*/i,'').trim();
      body = body.slice(0, nIdx).trim();
    }

    const items = [];
    const itemRe = /(?:^|\s)(\d+)\.\s+([^]+?)(?=(?:\s+\d+\.\s+)|$)/g;
    let m; while((m=itemRe.exec(body))!==null){ items.push(m[2].trim()); }

    if(items.length===0){
      const injected = body.replace(/(\d+)\.\s+/g, '\n$1. ');
      const parts = injected.split(/\n(?=\d+\.\s)/).map(s=>s.trim());
      if(parts.length>1){
        parts.forEach(p=> items.push(p.replace(/^\d+\.\s+/,'').trim()));
        body = body.replace(/^[\s\S]*?(?=\d+\.\s)/,'').trim();
      }
    }

    let intro = '';
    if(items.length){
      const firstIdx = body.search(/\d+\.\s+/);
      if(firstIdx > 0) intro = body.slice(0, firstIdx).trim().replace(/[;:,–—-]\s*$/,'');
    }

    const enhanceItem = (s)=>{
      let t = s;
      t = t.replace(
        /^([A-ZÁÉÍÓÚÑ][\wÁÉÍÓÚÑáéíóúñ.'-]+(?:\s+[A-ZÁÉÍÓÚÑ][\wÁÉÍÓÚÑáéíóúñ.'-]+)+)/,
        '<strong>$1</strong>'
      );
      t = t.replace(/\b(Proyecto|Project):\s*([^–—\-\n]+?)(?=(?:\s*(?:–|—|-)\s*|\s|$))/gi, '<strong>$1:</strong> <strong>$2</strong>');
      t = t.replace(/\b(Departamento|Department):\s*([^–—\-\n]+?)(?=(?:\s*(?:–|—|-)\s*|\s|$))/gi, '<strong>$1:</strong> <strong>$2</strong>');
      return t.trim();
    };

    let html = '';
    if(intro) html += `<p>${formatBasicContent(intro)}</p>`;
    if(items.length){
      html += '<ol>';
      items.forEach(it => html += `<li>${formatBasicContent(enhanceItem(it))}</li>`);
      html += '</ol>';
    }else{
      html += formatBasicContent(body);
    }
    if(note){ html += `<br><strong>Nota:</strong> ${formatBasicContent(note)}`; }
    return html;
  }

  function parseStructuredResponse(text) {
    const normalized = text.trim().replace(/\u00A0/g, ' ');
    
    let resultMatch = normalized.match(/\[RESULTADO\]([\s\S]*?)\[\/RESULTADO\]/i);
    let processMatch = normalized.match(/\[PROCESO\]([\s\S]*?)\[\/PROCESO\]/i);
    
    if (!resultMatch) {
      resultMatch = normalized.match(/\[RESULT\]([\s\S]*?)\[\/RESULT\]/i) ||
                    normalized.match(/RESULTADO:([\s\S]*?)(?=\[PROCESO\]|\[PROCESS\]|$)/i);
    }
    
    if (!processMatch) {
      processMatch = normalized.match(/\[PROCESS\]([\s\S]*?)\[\/PROCESS\]/i) ||
                     normalized.match(/PROCESO:([\s\S]*?)(?=\[RESULTADO\]|\[RESULT\]|$)/i);
    }
    
    if (resultMatch) {
      return {
        hasStructure: true,
        result: resultMatch[1].trim(),
        process: processMatch ? processMatch[1].trim() : 'No se proporcionó información del proceso.'
      };
    }
    
    return {
      hasStructure: false,
      result: normalized,
      process: ''
    };
  }

  function showContentWithAnimation(text, element, onComplete) {
    const formattedHTML = formatResultRich(text);
    element.innerHTML = formattedHTML;
    
    if (onComplete) {
      setTimeout(onComplete, 50);
    }
  }

  function buildStructuredMessage(resultText, processText){
    const id='m'+Date.now()+Math.floor(Math.random()*1e4);
    const html = `
      <div class="result-section" id="result-${id}"></div>
      <hr class="proc-sep">
      <div class="process-section">
        <div class="process-header" data-target="${id}">
          <span>Process</span><span class="process-arrow" id="arrow-${id}">▼</span>
        </div>
        <div class="process-content" id="process-${id}">
          ${formatBasicContent(processText)}
        </div>
      </div>`;
    return {id, html};
  }

  function toggleProcess(id){
    const proc=document.getElementById('process-'+id);
    const arrow=document.getElementById('arrow-'+id);
    if(!proc) return;
    const vis=proc.classList.toggle('visible');
    arrow.textContent=vis?'▲':'▼';
  }

  function scrollToBottom(){ 
    messagesDiv.scrollTop = messagesDiv.scrollHeight; 
  }

  async function sendMessage(){
    if (!currentUser) {
      showLogin();
      return;
    }

    const original = input.value.trim();
    if(!original || isLoading) return;
    const enhanced = memory.enhance(original);

    const u = document.createElement('div');
    u.className='message user-message';
    u.textContent=original.toUpperCase();
    messagesDiv.appendChild(u);

    input.value=''; input.focus();
    isLoading=true; sendBtn.disabled=true;

    const typing=document.createElement('div');
    typing.className='typing-indicator';
    typing.textContent='thinking…';
    messagesDiv.appendChild(typing);
    scrollToBottom();

    try{
      // Obtener token de sesión actual
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError || !session) {
        throw new Error('Sesión expirada');
      }

      console.log('📤 Enviando consulta con autenticación:', enhanced);
      
      const r = await fetch(`${SUPABASE_URL}/functions/v1/chat-query`,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'apikey':SUPABASE_ANON_KEY,
          'Authorization':`Bearer ${session.access_token}`
        },
        body:JSON.stringify({question:enhanced})
      });
      
      console.log('📡 Response status:', r.status);
      
      const data = await r.json();
      console.log('📊 Response data:', data);
      
      // Manejar errores de autenticación
      if (data.error === 'authentication_failed') {
        await supabase.auth.signOut();
        showError('Sesión expirada. Por favor, inicia sesión nuevamente.');
        return;
      }
      
      typing.remove();

      const a = document.createElement('div');
      a.className='message assistant-message';
      messagesDiv.appendChild(a);

      const full = data.answer || '—';
      memory.update(original, full);

      const parsedResponse = parseStructuredResponse(full);
      
      if(parsedResponse.hasStructure){
        const {id, html} = buildStructuredMessage(parsedResponse.result, parsedResponse.process);
        a.innerHTML = html;
        const resultEl = document.getElementById('result-'+id);

        showContentWithAnimation(parsedResponse.result, resultEl, () => {
          scrollToBottom();
        });

        const header = a.querySelector(`.process-header[data-target="${id}"]`);
        header.addEventListener('click', ()=>toggleProcess(id));
        
        requestAnimationFrame(() => {
          a.classList.add('visible');
        });
      }else{
        a.innerHTML = formatResultRich(full);
        
        requestAnimationFrame(() => {
          a.classList.add('visible');
        });
      }
      scrollToBottom();

    }catch(err){
      console.error('❌ Error:', err);
      typing.remove();
      
      let errorMessage = 'Error al conectar con el servidor.';
      if (err.message.includes('Sesión expirada')) {
        errorMessage = 'Sesión expirada. Redirigiendo al login...';
        setTimeout(() => {
          supabase.auth.signOut();
        }, 2000);
      }
      
      const e = document.createElement('div');
      e.className='message assistant-message';
      e.textContent = errorMessage + ' Intenta de nuevo.';
      messagesDiv.appendChild(e);
    }finally{
      isLoading=false; sendBtn.disabled=false;
    }
  }

  // EVENT LISTENERS
  loginBtn.addEventListener('click', signInWithGoogle);
  logoutBtn.addEventListener('click', signOut);
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });

  // INICIALIZACIÓN
  document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Distribution Chat con Autenticación iniciado');
    showLoading();
    
    // Verificar autenticación después de un breve delay
    setTimeout(() => {
      checkAuthState();
    }, 500);
  });
}
</script>
</body>
</html>